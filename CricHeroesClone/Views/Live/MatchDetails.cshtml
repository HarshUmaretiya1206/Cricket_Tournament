@using System.Linq
@using CricHeroesClone.Models
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Match Details";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cricket-bat-ball text-primary"></i> Match Details</h2>
                <div>
                    <a href="@Url.Action("Index", "Live")" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Live Matches
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (ViewBag.Match != null)
    {
        var match = ViewBag.Match;
        
        <!-- Match Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h4 class="mb-0">
                                    <i class="fas fa-trophy"></i> @match.TournamentName
                                </h4>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-success fs-6">@match.Status</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="text-center mb-3">@match.TeamAName</h5>
                                <div class="team-score-display text-center">
                                    <span class="score-number">@match.ScoreTeamA</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5 class="text-center mb-3">@match.TeamBName</h5>
                                <div class="team-score-display text-center">
                                    <span class="score-number">@match.ScoreTeamB</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <h6 class="text-muted">VS</h6>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Match Information -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-info-circle"></i> Match Information</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Venue:</strong><br>@match.Venue</p>
                                <p><strong>Date:</strong><br>@match.MatchDate?.ToString("MMM dd, yyyy HH:mm")</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Status:</strong><br>@match.Status</p>
                                <p><strong>Result:</strong><br>@(string.IsNullOrEmpty(match.Result) ? "TBD" : match.Result)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-toss"></i> Toss Information</h6>
                    </div>
                    <div class="card-body">
                        @if (match.TossWinnerTeamId.HasValue)
                        {
                            <p><strong>Toss Winner:</strong><br>@(match.TossWinnerTeamId == match.TeamAId ? match.TeamAName : match.TeamBName)</p>
                            <p><strong>Decision:</strong><br>@(string.IsNullOrEmpty(match.TossDecision) ? "TBD" : match.TossDecision)</p>
                        }
                        else
                        {
                            <p class="text-muted">Toss not yet taken</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Innings -->
        @if (ViewBag.Balls != null && ((IEnumerable<dynamic>)ViewBag.Balls).Any())
        {
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="fas fa-play-circle"></i> Current Innings</h6>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h4 class="text-primary">@match.CurrentRuns</h4>
                                        <small class="text-muted">Runs</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h4 class="text-danger">@match.CurrentWickets</h4>
                                        <small class="text-muted">Wickets</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h4 class="text-success">@match.CurrentOvers</h4>
                                        <small class="text-muted">Overs</small>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="stat-box">
                                        <h4 class="text-warning">@match.TargetRuns</h4>
                                        <small class="text-muted">Target</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Ball by Ball Commentary -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <h6 class="mb-0"><i class="fas fa-comment-alt"></i> Ball by Ball Commentary</h6>
                        </div>
                        <div class="card-body">
                            <div class="commentary-container">
                                @{ var balls = ViewBag.Balls as IEnumerable<BallByBall>; }
                                @if (balls != null)
                                {
                                    foreach (var ball in balls.OrderByDescending(b => b.Timestamp))
                                    {
                                    <div class="commentary-item">
                                        <div class="ball-header">
                                            <span class="ball-number">@ball.OverNumber.@ball.BallNumber</span>
                                            <span class="ball-time">@ball.Timestamp.ToString("HH:mm")</span>
                                        </div>
                                        <div class="ball-content">
                                            @if (ball.IsWicket)
                                            {
                                                <span class="ball-result wicket">
                                                    <i class="fas fa-times-circle"></i> WICKET!
                                                </span>
                                            }
                                            else if (ball.IsWide)
                                            {
                                                <span class="ball-result wide">
                                                    <i class="fas fa-arrow-right"></i> WIDE +@ball.ExtraRuns
                                                </span>
                                            }
                                            else if (ball.IsNoBall)
                                            {
                                                <span class="ball-result noball">
                                                    <i class="fas fa-exclamation-triangle"></i> NO BALL +@ball.ExtraRuns
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="ball-result runs">
                                                    @ball.Runs runs
                                                </span>
                                            }
                                        </div>
                                        @if (!string.IsNullOrEmpty(ball.Commentary))
                                        {
                                            <div class="ball-commentary">
                                                <small class="text-muted">@ball.Commentary</small>
                                            </div>
                                        }
                                    </div>
                                    }
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
        else
        {
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h5>Match Not Started</h5>
                        <p>Ball by ball commentary will appear here once the match begins.</p>
                    </div>
                </div>
            </div>
        }

        <!-- Actions -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <div class="btn-group">
                    <a href="@Url.Action("Viewer", "Live", new { matchId = match.Id })" 
                       class="btn btn-primary btn-lg">
                        <i class="fas fa-eye"></i> Watch Live
                    </a>
                    @inject Microsoft.AspNetCore.Http.IHttpContextAccessor HttpContextAccessor
                    @if (HttpContextAccessor.HttpContext != null && HttpContextAccessor.HttpContext.Session.GetString("UserRole") == "Scorer")
                    {
                        <a href="@Url.Action("ScoreMatch", "Scorer", new { matchId = match.Id })" 
                           class="btn btn-success btn-lg">
                            <i class="fas fa-edit"></i> Score Match
                        </a>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger">
            <h4>Match Not Found</h4>
            <p>The requested match could not be found.</p>
        </div>
    }
</div>

<style>
.team-score-display {
    padding: 20px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    border: 2px solid #dee2e6;
}

.score-number {
    font-size: 3rem;
    font-weight: bold;
    color: #495057;
}

.stat-box {
    padding: 15px;
    background-color: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

.commentary-container {
    max-height: 400px;
    overflow-y: auto;
}

.commentary-item {
    padding: 10px;
    border-bottom: 1px solid #dee2e6;
    margin-bottom: 10px;
}

.commentary-item:last-child {
    border-bottom: none;
}

.ball-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.ball-number {
    font-weight: bold;
    color: #495057;
    background-color: #e9ecef;
    padding: 2px 8px;
    border-radius: 4px;
}

.ball-time {
    font-size: 0.8em;
    color: #6c757d;
}

.ball-content {
    margin-bottom: 5px;
}

.ball-result {
    font-weight: bold;
    padding: 2px 8px;
    border-radius: 4px;
}

.ball-result.wicket {
    background-color: #dc3545;
    color: white;
}

.ball-result.wide {
    background-color: #ffc107;
    color: #212529;
}

.ball-result.noball {
    background-color: #fd7e14;
    color: white;
}

.ball-result.runs {
    background-color: #28a745;
    color: white;
}

.ball-commentary {
    font-style: italic;
    margin-top: 5px;
}

.card {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: box-shadow 0.3s ease;
}

.card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}
</style>
